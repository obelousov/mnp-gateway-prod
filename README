to re-build images (eg when update requirements.txt)
docker compose -f compose.yml -f compose-rabbitmq.yml up -d --build

docker compose -f compose.yml -f compose-rabbitmq.yml up -d
docker compose -f compose.yml -f compose-rabbitmq.yml down
docker compose -f compose.yml -f compose-rabbitmq.yml restart api

curl http://localhost:8090/api/v1/health
{"status":"healthy","service":"MNP Gateway API","version":"1.0.0","timestamp":1759602021.7271955}

https://mnp-api.olbe.tech/api/v1/healthcheck

curl http://localhost:8090
{"message":"MNP Gateway Service is running"}

curl -X POST http://localhost:8090/api/v1/query-msisdn
{"status":"MSISDN Query accepted","service":"Gateway for handling MNP queries between BSS and Central Node","version":"1.0.0","timestamp":1759611472.214557}

adminer
root:root
http://localhost:8060/?server=db&username=pondphone&db=mnp_database

grafana
http://localhost:3000/login

traefik dashboard
http://localhost:8080/dashboard/
http://localhost:8080/dashboard/#/http/routers

swagger docs
https://mnp-api.olbe.tech/docs
https://mnp-api.olbe.tech/redoc

planUML
http://localhost:9090

curl -k -u "apiuser:api@password" https://mnp-api.olbe.tech/api/v1/healthcheck

to generate self-signed certifciate for testing:
openssl req -x509 -nodes -days 365 -newkey rsa:2048   -keyout traefik/certs/private.key   -out traefik/certs/certificate.crt   -subj "/C=US/ST=State/L=City/O=MNP/CN=mnp-api.olbe.tech"   -addext "subjectAltName=DNS:mnp-api.olbe.tech,DNS:localhost,IP:127.0.0.1"
  705  openssl x509 -in traefik/certs/certificate.crt -text -noout | grep -A 5 "X509v3"

=== DB schema ===
SET NAMES utf8;
SET time_zone = '+00:00';
SET foreign_key_checks = 0;
SET sql_mode = 'NO_AUTO_VALUE_ON_ZERO';

SET NAMES utf8mb4;

DROP DATABASE IF EXISTS `mnp_database`;
CREATE DATABASE `mnp_database` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */;
USE `mnp_database`;

DROP TABLE IF EXISTS `portability_requests`;
CREATE TABLE `portability_requests` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `country_code` varchar(3) NOT NULL DEFAULT 'ESP',
  `request_type` enum('PORT_IN','PORT_OUT','CANCELLATION','MULTISIM','EXTENSION') NOT NULL,
  `cancel_request_id` bigint(20) NOT NULL DEFAULT 0 COMMENT 'id of portin request',
  `reference_code` varchar(100) DEFAULT '' COMMENT 'Unique reference from NC system',
  `session_code` varchar(100) DEFAULT NULL COMMENT 'Session identifier from BSS',
  `session_code_nc` varchar(100) DEFAULT NULL COMMENT 'Session identifier from NC',
  `request_code` varchar(100) DEFAULT NULL COMMENT 'Internal request identifier',
  `status_bss` varchar(50) DEFAULT 'PROCESSING' COMMENT 'BSS system status',
  `status_nc` varchar(50) DEFAULT 'PENDING' COMMENT 'NC system status',
  `response_code` varchar(20) DEFAULT '' COMMENT 'coddigoRespuesta',
  `response_status` varchar(20) DEFAULT '' COMMENT 'Latest response code from NC',
  `reject_code` varchar(10) DEFAULT '' COMMENT 'reject status eg RECH_BNUME RECH_PERDI RECH_IDENT RECH_ICCID',
  `description` varchar(1000) DEFAULT NULL,
  `retry_count` int(11) DEFAULT 0,
  `last_error` text DEFAULT NULL COMMENT 'Last error message',
  `msisdn` varchar(15) NOT NULL DEFAULT '' COMMENT 'Phone number',
  `iccid` varchar(22) DEFAULT NULL COMMENT 'SIM card number',
  `subscriber_type` enum('person','company') DEFAULT NULL COMMENT 'person/company',
  `document_type` enum('NIF','CIF','NIE','PAS') NOT NULL,
  `document_number` varchar(50) NOT NULL DEFAULT '',
  `first_name` varchar(100) DEFAULT NULL,
  `first_surname` varchar(100) DEFAULT NULL,
  `second_surname` varchar(100) DEFAULT NULL,
  `nationality` varchar(3) DEFAULT 'ESP',
  `name_surname` varchar(200) NOT NULL DEFAULT '',
  `contract_number` varchar(100) DEFAULT NULL COMMENT 'Subscriber contract number',
  `donor_operator` varchar(50) NOT NULL DEFAULT '' COMMENT 'Current operator',
  `recipient_operator` varchar(50) NOT NULL DEFAULT '' COMMENT 'New operator',
  `routing_number` varchar(20) DEFAULT '' COMMENT 'Routing information',
  `desired_porting_date` varchar(20) DEFAULT NULL,
  `porting_window` datetime DEFAULT NULL COMMENT 'Scheduled porting window date/time from NC',
  `reason_code` varchar(50) DEFAULT NULL COMMENT 'Reason for port-out',
  `cancellation_reason` varchar(150) DEFAULT NULL,
  `cancellation_initiated_by_donor` varchar(150) DEFAULT NULL,
  `requested_at` timestamp NULL DEFAULT NULL COMMENT 'When customer requested',
  `scheduled_at` timestamp NULL DEFAULT NULL COMMENT 'When to process next',
  `completed_at` timestamp NULL DEFAULT NULL COMMENT 'When request completed',
  `created_at` timestamp NULL DEFAULT current_timestamp(),
  `updated_at` timestamp NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  `is_legal_entity` tinyint(1) NOT NULL DEFAULT 0 COMMENT 'Flag indicating if this is a legal entity (1) or individual (0)',
  `company_name` varchar(255) DEFAULT NULL COMMENT 'Company name for legal entities',
  PRIMARY KEY (`id`),
  KEY `idx_country_type` (`country_code`,`request_type`),
  KEY `idx_status_composite` (`status_nc`,`status_bss`,`scheduled_at`),
  KEY `idx_msisdn` (`msisdn`),
  KEY `idx_reference_code` (`reference_code`),
  KEY `idx_session_code` (`session_code`),
  KEY `idx_donor_recipient` (`donor_operator`,`recipient_operator`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_scheduled_status` (`scheduled_at`,`status_nc`),
  KEY `idx_completion` (`completed_at`,`country_code`),
  KEY `idx_document` (`document_type`,`document_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Mobile number portability requests (IN/OUT/CANCEL/MULTISIM)';

DROP TABLE IF EXISTS `portout_metadata`;
CREATE TABLE `portout_metadata` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `response_code` varchar(50) DEFAULT NULL,
  `response_description` varchar(255) DEFAULT NULL,
  `paged_request_code` varchar(100) DEFAULT NULL,
  `total_records` int(11) DEFAULT NULL,
  `is_last_page` tinyint(1) DEFAULT NULL,
  `received_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id`),
  KEY `idx_response_code` (`response_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `portout_request`;
CREATE TABLE `portout_request` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `metadata_id` bigint(20) NOT NULL,
  `notification_id` varchar(50) DEFAULT NULL,
  `creation_date` datetime DEFAULT NULL,
  `synchronized` tinyint(1) DEFAULT NULL,
  `reference_code` varchar(50) DEFAULT NULL,
  `status_bss` varchar(50) DEFAULT NULL,
  `submitted_to_bss` tinyint(1) DEFAULT 0 COMMENT '0 - not subitted ,1 - submitted',
  `status_nc` varchar(50) DEFAULT NULL,
  `status` varchar(10) DEFAULT NULL,
  `response_code` varchar(10) DEFAULT NULL,
  `description` varchar(200) DEFAULT NULL COMMENT 'descroption with return NC on reject or confirm',
  `state_date` datetime DEFAULT NULL,
  `creation_date_request` datetime DEFAULT NULL,
  `reading_mark_date` datetime DEFAULT NULL,
  `state_change_deadline` datetime DEFAULT NULL,
  `subscriber_request_date` datetime DEFAULT NULL,
  `donor_operator_code` varchar(10) DEFAULT NULL,
  `receiver_operator_code` varchar(10) DEFAULT NULL,
  `extraordinary_donor_activation` tinyint(1) DEFAULT NULL,
  `contract_code` varchar(100) DEFAULT NULL,
  `receiver_NRN` varchar(50) DEFAULT NULL,
  `port_window_date` datetime DEFAULT NULL,
  `port_window_by_subscriber` tinyint(1) DEFAULT NULL,
  `MSISDN` varchar(20) DEFAULT NULL,
  `subscriber_type` varchar(20) DEFAULT 'person' COMMENT 'person or legal',
  `subscriber_id_type` varchar(10) DEFAULT NULL,
  `subscriber_id_number` varchar(30) DEFAULT NULL,
  `subscriber_first_name` varchar(100) DEFAULT NULL,
  `subscriber_last_name_1` varchar(100) DEFAULT NULL,
  `subscriber_last_name_2` varchar(100) DEFAULT NULL,
  `company_name` varchar(100) DEFAULT NULL,
  `scheduled_at` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT current_timestamp(),
  `updated_at` timestamp NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id`),
  KEY `idx_metadata_id` (`metadata_id`),
  KEY `idx_msisdn` (`MSISDN`),
  KEY `idx_reference_code` (`reference_code`),
  CONSTRAINT `portout_request_ibfk_1` FOREIGN KEY (`metadata_id`) REFERENCES `portout_metadata` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

flower:
http://localhost:5555/
admin: admin

with RabitMQ
docker compose -f compose.yml -f compose-rabbitmq.yml up -d
docker compose -f compose.yml -f compose-rabbitmq.yml up -d --force-recreate
docker compose -f compose.yml -f compose-rabbitmq.yml down

RabitMQ UI
http://localhost:15672/#/
admin: admin123

root@7e62fac0f3f3:/app# python -m services.soap_builder
root@b56786830fcc:/app# python -m services.time_services

docker exec -it mnp-api bash
root@b56786830fcc:/app# python -m tests.nc_qeries

docker exec mnp-api python -m tests.nc_qeries

url to submit queries from app
https://sms2email.olbe.tech/webhook_receiver
here can see body of requests sent from mnp-gateway app
https://sms2email.olbe.tech/webhook_dashboard
